(function(c){function q(a,b,d,h){if(d&&h){var c=a/d,k=b/h;return c>k?{width:d,height:b/c}:{width:a/k,height:h}}return d?{width:d,height:b/(a/d)}:h?{width:a/(b/h),height:h}:{width:a,height:b}}function r(a){return/[.]/.exec(a)?/[^.]+$/.exec(a.toLowerCase()):""}c.support.cors=!0;var p=function(a,b){var d=this;d.e=c(a);d.o=c.extend({},c.fn.imagecropper.defaults,b);d.r=window.FileReader||!1;if(d.r){d.createInput();d.events();if(d.o.drop)d.e.on("dragenter dragover dragleave drop",function(){return!1}); d.o.crop&&d.createModal();if(d.o.ratio.length){var h=d.o.ratio[0].split("/");d.ratio=parseInt(h[0])/parseInt(h[1]);for(var e=0;e<d.o.ratio.length;e++)h=d.o.ratio[e].split("/"),d.modalHeader.append(c('<input type="button">').data({ratio:parseInt(h[0])/parseInt(h[1])}).val(h.toString()).attr(0==e?{disabled:"disabled"}:{}));d.modalHeader.delegate('input[type="button"]:not(:disabled)',"click",function(){d.ratio=c(this).data().ratio;d.modalHeader.find('input[type="button"]').removeAttr("disabled");c(this).attr({disabled:"disabled"}); d.setSelect(d.ratio)})}d.scaleX=1;d.scaleY=1}else throw Error("Oh! Sorry, FileReader not supported by the browser");};p.prototype={constructor:p,events:function(a,b){var d=this;d.e.on("mouseover",function(){var a=d.e[0],b=d.div.css("visibility","visible"),c,l;if(document.documentElement.getBoundingClientRect){c=a.getBoundingClientRect();var g=a.ownerDocument;l=g.body;var g=g.documentElement,m=g.clientTop||l.clientTop||0,n=g.clientLeft||l.clientLeft||0,f=1;l.getBoundingClientRect&&(f=l.getBoundingClientRect(), f=(f.right-f.left)/l.clientWidth);1<f&&(n=m=0);m=c.top/f+(window.pageYOffset||g&&g.scrollTop/f||l.scrollTop/f)-m;l=c.left/f+(window.pageXOffset||g&&g.scrollLeft/f||l.scrollLeft/f)-n}else m=0+(a.offsetTop||0),l=0+(a.offsetLeft||0);c=m;b.css({position:"absolute",left:l,top:c,width:a.offsetWidth,height:a.offsetHeight})})},createInput:function(){var a=this;a.input=c("<input>").attr("type","file").css({position:"absolute",right:0,margin:0,padding:0,height:"100%",fontSize:"480px",fontFamily:"sans-serif", cursor:"pointer"});a.div=c("<div>").css({display:"block",position:"absolute",overflow:"hidden",margin:0,padding:0,opacity:0,direction:"ltr",zIndex:2147483581});a.o.multiple&&a.input.attr("multiple","multiple");if("0"!==a.div.css("opacity")){if("undefined"==typeof a.div.context.filters)throw Error("Opacity not supported by the browser");a.div.css("filter","alpha(opacity=0)")}a.input.change(function(){a.input&&""!==a.input.val()&&a.getFiles(this.files)}).mouseover(function(){a.e.addClass(a.o.hoverClass)}).mouseout(function(){a.e.removeClass(a.o.hoverClass); a.e.removeClass(a.o.focusClass)}).focus(function(){a.e.addClass(a.o.focusClass)}).blur(function(){a.e.removeClass(a.o.focusClass)});c("body").append(this.div.append(this.input))},getFiles:function(a){var b=this,d,c=a.length,e;b.images=[];for(d=b.s=0;d<c&&a[d].type.match(/image.*/);d++)e=new FileReader,e.readAsDataURL(a[d]),function(d){e.onload=function(c){b.file=a[d].name.replace(/.*(\/|\\)/,"");var g=new Image;g.src=c.target.result;g.onload=function(){setTimeout(function(){q(g.width,g.height,b.o.maxWidth, b.o.maxHeight);b.width=g.width;b.height=g.height;b.images.push({img:g,name:a[d].name,type:a[d].type,size:a[d].size});0==d&&b.o.crop?b.showModal():b.o.crop||b.upload(g.src);b.o.onChange(b.file,r(b.file),b.render=c.target.result)},1)}}}(d)},crop:function(){var a=this.selection,b=document.createElement("canvas"),d=b.getContext("2d");b.width=a.w*this.scaleX;b.height=a.h*this.scaleY;d.drawImage(this.img,a.x*this.scaleX,a.y*this.scaleY,a.w*this.scaleX,a.h*this.scaleY,0,0,a.w*this.scaleX,a.h*this.scaleY); return b.toDataURL(this.type)},createModal:function(){var a=this,b;a.modal=c("<div>",{"class":"imagecropper_modal fade"}).append(a.modalHeader=c("<div>",{"class":"imagecropper_header"}).append(c("<div>",{"class":"imagecropper_close"}).text("\u00d7").click(function(){a.hideModal()}),c("<h3>",{"class":"imagecropper_title"}).text("Cropping image"),a.setWidth=c("<input>",{type:"text",placeholder:"width"}),a.setHeight=c("<input>",{type:"text",placeholder:"height"})),c("<div>",{"class":"imagecropper_content"}).append(a.canvas= c("<canvas>")),c("<div>",{"class":"imagecropper_footer"}).append(a.buttonNo=c("<button>",{"class":"imagecropper_no"}).text("Skip"),a.buttonOk=c("<button>",{"class":"imagecropper_ok"}).text("Crop")));a.backdrop=c("<div>",{"class":"imagecropper_backdrop fade"}).click(function(){a.hideModal()});c("body").append(a.modal);a.setWidth.on("keyup change",function(){10<c(this).val()&&(a.selection.w=c(this).val()/a.scaleX);a.selection.x+a.selection.w>=a.canvas[0].width&&c(this).val(a.selection.w=a.canvas[0].width- a.selection.x);b=a.selection.xywh();a.updateCanvas(b.x,b.y,b.w,b.h,a.canvas,a.ctx)});a.setHeight.on("keyup change",function(){10<c(this).val()&&(a.selection.h=c(this).val()/a.scaleY);a.selection.y+a.selection.h>=a.canvas[0].height&&c(this).val(a.selection.h=a.canvas[0].height-a.selection.y);b=a.selection.xywh();a.updateCanvas(b.x,b.y,b.w,b.h,a.canvas,a.ctx)});a.buttonOk.on("click",function(){a.upload(a.crop());a.check()});a.buttonNo.on("click",function(){a.upload(a.img.src);a.check()})},showModal:function(){this.modal.addClass("in"); c("body").append(this.backdrop.addClass("in").show());this.createCanvas();this.setSelect()},hideModal:function(){this.modal.animate({width:560,marginLeft:-280}).removeClass("in").find(".imagecropper-content").height(200);this.backdrop.removeClass("in").hide();this.s=0;this.images=[]},createCanvas:function(){this.ctx=this.canvas[0].getContext("2d");this.img=this.images[this.s].img;this.type=this.images[this.s].type;this.result=[];var a=this.img;this.scale_size=!1;if(a.width>c(window).width()-150|| a.height>c(window).height()-150)this.scale_size=q(a.width,a.height,c(window).width()-150,c(window).height()-150),this.scaleX=a.width/this.scale_size.width,this.scaleY=a.height/this.scale_size.height,a.width=this.scale_size.width,a.height=this.scale_size.height;this.modal.css({width:this.scale_size?this.scale_size.width+2*parseInt(this.modal.find(".imagecropper_content").css("padding-left")):a.width+2*parseInt(this.modal.find(".imagecropper_content").css("padding-left"))}).animate({marginLeft:this.scale_size? -(this.scale_size.width/2):-(a.width/2),marginTop:this.scale_size?-(this.scale_size.height/2)-60:-(a.height/2)-60}).find(".imagecropper_content").animate({height:this.scale_size?this.scale_size.height:a.height});this.canvas[0].width=a.width;this.canvas[0].height=a.height},setSelect:function(){this.o.ratio.length?(1<this.ratio?(this.moveW=Math.floor(this.canvas.width()/2),this.moveH=Math.floor(this.moveW/this.ratio)):(this.moveH=Math.floor(this.canvas.height()/2),this.moveW=Math.floor(this.moveH*this.ratio)), this.initX=Math.floor((this.canvas.width()-this.moveW)/2),this.initY=Math.floor((this.canvas.height()-this.moveH)/2)):(this.initX=Math.floor(this.canvas.width()/4),this.initY=Math.floor(this.canvas.height()/4),this.moveW=Math.floor(this.canvas.width()/2),this.moveH=Math.floor(this.canvas.height()/2));this.selection=new this.rect(this.initX,this.initY,this.moveW,this.moveH,3);this.updateCanvas(this.initX,this.initY,this.moveW,this.moveH);this.createCorners();this.canvasEvents()},drawSelect:function(a, b,d,c){var e=this.ctx,k=this.img,l=k.width/this.width,g=k.height/this.height,m=this.width/k.width,n=this.height/k.height;e.save();e.scale(l,g);e.drawImage(k,a*m,b*n,d*m,c*n,a*m,b*n,d*m,c*n);e.restore()},updateCanvas:function(a,b,d,c){var e=this.canvas[0],k=this.ctx;k.fillStyle="rgba(0, 0, 0, 0.5)";k.clearRect(0,0,e.width,e.height);k.drawImage(this.img,0,0,this.img.width,this.img.height);k.fillRect(0,0,e.width,e.height);k.clearRect(a,b,d,c);this.drawSelect(a,b,d,c)},createCorners:function(){var a= this.ctx,b,d,c,e=this.selection.points,k=e.length;a.fillStyle="#ffffff";a.strokeStyle="rgba(0, 0, 0, 5)";this.corners=[];for(c=0;c<k;c++)b=e[c],d=new this.rect(b.x-3,b.y-3,8,8),d.parent=b,this.corners.push(d),a.fillRect(b.x-3,b.y-3,8,8),a.strokeRect(b.x-3,b.y-3,8,8)},check:function(){this.s++;this.images.length>this.s?(this.createCanvas(),this.setSelect()):this.hideModal()},canvasEvents:function(){var a=this,b,d,h;a.canvas.mousedown(function(e){b=e.pageX-a.canvas.offset().left;d=e.pageY-a.canvas.offset().top; if(a.selection.hasPoint(b,d))a.dragStartX=b,a.dragStartY=d,c(document).mousemove(function(c){b=c.pageX-a.canvas.offset().left;d=c.pageY-a.canvas.offset().top;a.dragMoveW=b-a.dragStartX;a.dragMoveH=d-a.dragStartY;a.selection.drag(a.dragMoveW,a.dragMoveH,a.canvas);h=a.selection.xywh2();a.updateCanvas(h.x,h.y,h.w,h.h,a.canvas,a.ctx)}).mouseup(function(){c(document).unbind("mousemove mouseup");a.selection.renewPoints();h=a.selection.xywh2();a.updateCanvas(h.x,h.y,h.w,h.h,a.canvas,a.ctx);a.createCorners()}); else{e=a.corners;var k,l,g,m;l=0;for(k=e.length;l<k;l++){var n=e[l];if(n.hasPoint(b,d)){g=a.selection.points;for(var f=0;f<g.length;f++)if(m=g[f],m.x===n.parent.x&&m.y===n.parent.y){var t=c.inArray(m,a.selection.points),u=m.x,p=m.y;c(document).mousemove(function(c){var g;b=c.pageX-a.canvas.offset().left;d=c.pageY-a.canvas.offset().top;b>a.canvas.width()&&(b=a.canvas.width());d>a.canvas.height()&&(d=a.canvas.height());1>b&&(b=0);1>d&&(d=0);c=b-u;if(a.ratio)switch(t){case 0:g=c/a.ratio;break;case 2:g= c/a.ratio;break;case 1:g=c/a.ratio*-1;break;case 3:g=c/a.ratio*-1}else g=d-p;a.selection.translate(t,u+c,p+g,a.canvas);g=a.selection.xywh();a.updateCanvas(g.x,g.y,g.w,g.h,a.canvas,a.ctx);a.setWidth.val(Math.floor(g.w));a.setHeight.val(Math.floor(g.h))}).mouseup(function(){c(document).unbind("mousemove mouseup");a.createCorners()})}}}}})},rect:function(a,b,d,c,e){this.x=a;this.y=b;this.w=d;this.h=c;this.padding=e;this.points=[{x:this.x,y:this.y},{x:this.x+this.w,y:this.y},{x:this.x+this.w,y:this.y+ this.h},{x:this.x,y:this.y+this.h}];this.newPoints=[];this.drag=function(a,b,c){this.newx=this.x+a;this.newy=this.y+b;1>this.newx&&(this.newx=0);1>this.newy&&(this.newy=0);this.newx>c.width()-this.w&&(this.newx=c.width()-this.w);this.newy>c.height()-this.h&&(this.newy=c.height()-this.h);0>this.w&&(1>this.newx-Math.abs(this.w)&&(this.newx=Math.abs(this.w)),this.newx>c.width()&&(this.newx=c.width()));0>this.h&&(1>this.newy-Math.abs(this.h)&&(this.newy=Math.abs(this.h)),this.newy>c.height()&&(this.newy= c.height()))};this.xywh=function(){return{x:this.x,y:this.y,w:this.w,h:this.h}};this.xywh2=function(){return{x:this.newx,y:this.newy,w:this.w,h:this.h}};this.hasPoint=function(a,b){var c,d,n,f,e,h;e=this.padding||0;d=this.points[0];h=this.points[2];d.x<h.x?(n=d.x,c=h.x):(n=h.x,c=d.x);d.y<h.y?(f=d.y,d=h.y):(f=h.y,d=d.y);return a>n+e&&a<c-e&&b>f+e&&b<d-e?!0:!1};this.translate=function(a,b,c,d){var e=this.points,f=[{},{},{},{}];switch(a){case 0:f[0]={x:b,y:c};f[1]={x:e[1].x,y:c};f[2]={x:e[2].x,y:e[2].y}; f[3]={x:b,y:e[3].y};break;case 1:f[0]={x:e[0].x,y:c};f[1]={x:b,y:c};f[2]={x:b,y:e[2].y};f[3]={x:e[3].x,y:e[3].y};break;case 2:f[0]={x:e[0].x,y:e[0].y};f[1]={x:b,y:e[1].y};f[2]={x:b,y:c};f[3]={x:e[3].x,y:c};break;case 3:f[0]={x:b,y:e[0].y},f[1]={x:e[1].x,y:e[1].y},f[2]={x:e[2].x,y:c},f[3]={x:b,y:c}}a=f[0].x;b=f[0].y;c=f[2].x-f[0].x;e=f[2].y-f[0].y;1>c||1>e||c+a>d.width()||e+b>d.height()||0>a||0>b||(this.points[0]=f[0],this.points[1]=f[1],this.points[2]=f[2],this.points[3]=f[3],this.x=a,this.y=b,this.w= c,this.h=e)};this.renewPoints=function(){this.x=this.newx;this.y=this.newy;this.points=[{x:this.x,y:this.y},{x:this.x+this.w,y:this.y},{x:this.x+this.w,y:this.y+this.h},{x:this.x,y:this.y+this.h}]}},upload:function(a){var b=this,d={};d[b.o.name]={};d[b.o.name].tmp=a;d[b.o.name].size=b.images[b.s].size;d[b.o.name].name=b.images[b.s].name;d[b.o.name].type=b.images[b.s].type;for(var h in b.o.data)d[h]=b.o.data[h];b.o.onSubmit(b.file,r(b.file),a);c.post(b.o.url,d,function(c){b.o.onComplete(b.e,b.file, c,a)})}};c.fn.imagecropper=function(a){return this.each(function(){var b=c(this);b.data("imagecropper")||b.data("imagecropper",new p(this,a))})};c.fn.imagecropper.defaults={url:"/upload.php",name:"file",multiple:!1,ratio:[],data:{},drop:!1,crop:!0,maxWidth:!1,maxHeight:!1,hoverClass:"hover",focusClass:"focus",onChange:function(){},onSubmit:function(){},onComplete:function(){}}})(jQuery);